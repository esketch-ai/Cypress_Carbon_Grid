#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# Function to check if a process is running on a given port
function is_port_in_use() {
  lsof -i :$1 > /dev/null
}

# Start Rails backend
if is_port_in_use 3000; then
  echo "Rails server already running on port 3000."
else
  echo "Starting Rails server..."
  bundle config set --local path vendor/bundle
  bundle install
  rails db:migrate
  rails db:seed
  rails s -p 3000 -b 0.0.0.0 &
  RAILS_PID=$!
  echo "Rails server started with PID $RAILS_PID"
fi

# Start React frontend
if is_port_in_use 3001; then
  echo "React development server already running on port 3001."
else
  echo "Starting React development server..."
  cd carbon_grid
  npm install
  PORT=3001 npm start &
  REACT_PID=$!
  echo "React development server started with PID $REACT_PID"
  cd ..
fi

# Keep the script running to keep the Replit environment alive
wait